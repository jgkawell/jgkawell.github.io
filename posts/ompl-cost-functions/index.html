<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Custom Cost Function for OMPL &amp; MoveIt! through ROS" /><meta property="og:locale" content="en" /><meta name="description" content="This post has been a long time coming. If you’ve read some of my other tutorials you’ll notice that those development posts have all been helpful in getting to this point. In this post I’ll cover how to setup OMPL with a custom optimization objective that reaches out to the ROS stack for its cost function. This requires installing OMPL and MoveIt! from source and an addition to the OMPL source code that links OMPL to a ROS service that returns the cost value associated with a given state. All of this allows you to easily swap in custom cost functions that OMPL will use for optimizing planners (RRT*, etc.)." /><meta property="og:description" content="This post has been a long time coming. If you’ve read some of my other tutorials you’ll notice that those development posts have all been helpful in getting to this point. In this post I’ll cover how to setup OMPL with a custom optimization objective that reaches out to the ROS stack for its cost function. This requires installing OMPL and MoveIt! from source and an addition to the OMPL source code that links OMPL to a ROS service that returns the cost value associated with a given state. All of this allows you to easily swap in custom cost functions that OMPL will use for optimizing planners (RRT*, etc.)." /><link rel="canonical" href="https://jack.kawell.us/posts/ompl-cost-functions/" /><meta property="og:url" content="https://jack.kawell.us/posts/ompl-cost-functions/" /><meta property="og:site_name" content="Jack Kawell" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-10-29T12:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Custom Cost Function for OMPL &amp; MoveIt! through ROS" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-06-19T13:52:03-05:00","datePublished":"2019-10-29T12:00:00-05:00","description":"This post has been a long time coming. If you’ve read some of my other tutorials you’ll notice that those development posts have all been helpful in getting to this point. In this post I’ll cover how to setup OMPL with a custom optimization objective that reaches out to the ROS stack for its cost function. This requires installing OMPL and MoveIt! from source and an addition to the OMPL source code that links OMPL to a ROS service that returns the cost value associated with a given state. All of this allows you to easily swap in custom cost functions that OMPL will use for optimizing planners (RRT*, etc.).","headline":"Custom Cost Function for OMPL &amp; MoveIt! through ROS","mainEntityOfPage":{"@type":"WebPage","@id":"https://jack.kawell.us/posts/ompl-cost-functions/"},"url":"https://jack.kawell.us/posts/ompl-cost-functions/"}</script><title>Custom Cost Function for OMPL & MoveIt! through ROS | Jack Kawell</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Jack Kawell"><meta name="application-name" content="Jack Kawell"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Jack Kawell</a></div><div class="site-subtitle font-italic">I build stuff <a hidden rel="me" href="https://mastodon.world/@jgkawell">Mastodon</a></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/resume/" class="nav-link"> <i class="fa-fw fas fa-document ml-xl-3 mr-xl-3 unloaded"></i> <span>RESUME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/jgkawell" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://mastodon.world/@jgkawell" aria-label="mastodon" target="_blank" rel="noopener"> <i class="fab fa-mastodon"></i> </a> <a href="https://www.linkedin.com/in/jack-kawell" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Custom Cost Function for OMPL & MoveIt! through ROS</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Custom Cost Function for OMPL & MoveIt! through ROS</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/jgkawell">Jack Kawell</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1572368400" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2019-10-29 </em> </span> <span> Updated <em class="timeago" data-ts="1655664723" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-06-19 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1886 words"> <em>10 min</em> read</span></div></div></div><div class="post-content"><p>This post has been a long time coming. If you’ve read some of my other tutorials you’ll notice that those development posts have all been helpful in getting to this point. In this post I’ll cover how to setup OMPL with a custom optimization objective that reaches out to the ROS stack for its cost function. This requires installing OMPL and MoveIt! from source and an addition to the OMPL source code that links OMPL to a ROS service that returns the cost value associated with a given state. All of this allows you to easily swap in custom cost functions that OMPL will use for optimizing planners (RRT*, etc.).</p><p>This is a pretty lengthy walk through, but I hope you can see the potential of this kind of a system. It allows you to do two very powerful things:</p><ol><li>It allows you to easily add and modify optimization objectives (cost functions) for OMPL without having to touch the OMPL source code. This means that you can modify cost functions without having to recompile. Note also that you can even have the whole system running, take down your cost server and launch a new one without ever having to stop your main OMPL/MoveIt!/rviz client. Also you can see that your cost function doesn’t have to be written in C++. These demo ones are written in Python even though OMPL is written in C++!<li>This system also allows for your cost functions to leverage the full power of the ROS stack. While OMPL has a limited understanding of the environment it operates in, your cost function can read from any ROS topic you’d like. This means your cost function can utilize sensor data or even user input which allows it to be a dynamic part of your system.</ol><p>This post will walk you through how to setup a development environment where you can have all of this running. By the end of this tutorial you should be able to write your own cost functions as ROS services that OMPL will pull from for its optimizing planners.</p><p>NOTE: Like a lot of my previous posts, this is a functional solution and could definitely be improved (and in fact I am currently working on improving it). Please let me know of any improvements that you can think of.</p><h3 id="initial-setup"><span class="mr-2">Initial Setup</span><a href="#initial-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>To begin with, you’ll need a working development environment for OMPL and MoveIt!. I’ve already written a blog post on how to do this so check that out <a href="/posts/ompl-moveit-custom-motion-planning">here</a>. Walk through that post first with either a Docker or bare-bones Ubuntu/WSL and then come back here to walk through these addition steps.</p><h3 id="ompl-setup"><span class="mr-2">OMPL Setup</span><a href="#ompl-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Okay, so you now have a working OMPL and MoveIt! development environment. Now let’s get to the good stuff.</p><p>First we need to checkout our custom planning branch for OMPL. You’ll remember from the installation walk-through that we cloned the CAIRO fork of OMPL. This already gives us access to the branch we need so we can simply move into the OMPL source directory and change branches:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">cd</span> ~/ws_moveit/src/ompl
git checkout custom-cost
</pre></table></code></div></div><p>Now that we’ve got a new version of OMPL checked out we’ll need to rebuild the workspace. However, before we do that we want to change a couple things.</p><h3 id="moveit-setup"><span class="mr-2">MoveIt! Setup</span><a href="#moveit-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>First, we need to make a couple changes to the MoveIt! source code. This is so that MoveIt! will recognize our new optimization objective that will call out to our ROS service for a cost function. All we need to do is edit the file <code class="language-plaintext highlighter-rouge">src/moveit/moveit_planners/ompl/ompl_interface/src/model_based_planning_context.cpp</code>. Open this file up in your favorite text editor.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">cd</span> ../src/moveit
gedit ./moveit_planners/ompl/ompl_interface/src/model_based_planning_context.cpp
</pre></table></code></div></div><p>Right at the end of the include statements (around line 60) you’ll want to add the following include for our new objective <code class="language-plaintext highlighter-rouge">#include&amp;nbsp;"ompl/base/objectives/CustomObjective.h"</code>. This means it will now look like the following:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"ompl/base/objectives/MaximizeMinClearanceObjective.h"</span><span class="cp">
#include</span> <span class="cpf">"ompl/base/objectives/CustomObjective.h"</span><span class="c1"> // Add our new objective</span><span class="cp">
</span>
<span class="n">ompl_interface</span><span class="o">::</span><span class="n">ModelBasedPlanningContext</span><span class="p">...</span>
</pre></table></code></div></div><p>Now scroll down to the switch case defining the different optimization objectives (around line 295). Here you’ll need to add another <code class="language-plaintext highlighter-rouge">else if</code> case that will allow MoveIt! to recognize our new objective. The final code should look like the following:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">optimizer</span> <span class="o">==</span> <span class="s">"MaximizeMinClearanceObjective"</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">objective</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">ompl</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">MaximizeMinClearanceObjective</span><span class="p">(</span><span class="n">ompl_simple_setup_</span><span class="o">-&gt;</span><span class="n">getSpaceInformation</span><span class="p">()));</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">optimizer</span> <span class="o">==</span> <span class="s">"CustomObjective"</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Add our new objective</span>
    <span class="n">objective</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">ompl</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">CustomObjective</span><span class="p">(</span><span class="n">ompl_simple_setup_</span><span class="o">-&gt;</span><span class="n">getSpaceInformation</span><span class="p">()));</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">objective</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">ompl</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="n">PathLengthOptimizationObjective</span><span class="p">(</span><span class="n">ompl_simple_setup_</span><span class="o">-&gt;</span><span class="n">getSpaceInformation</span><span class="p">()));</span>
  <span class="p">}</span>
</pre></table></code></div></div><p>Now MoveIt! should recognize our custom objective after we rebuild our workspace. Let’s do that now.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>catkin build
</pre></table></code></div></div><h3 id="custom-cost-servers-setup"><span class="mr-2">Custom Cost Servers Setup</span><a href="#custom-cost-servers-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Now for the good stuff! We can now add some custom cost servers to the mix. These can be whatever you’d like, but to demonstrate how they work, I’ve built a couple dummy ones in the CAIRO GitHub. Let’s clone that repo into our workspace.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">cd</span> ~/ws_moveit/src
git clone https://github.com/cairo-robotics/ompl_cost_server_demos.git
</pre></table></code></div></div><p>If you take a quick look through the code, you’ll notice that this repo is a super basic ROS package that consists of a few cost servers. Let’s take a quick look at the random number one:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python
</span>
<span class="kn">from</span> <span class="nn">ompl.srv</span> <span class="kn">import</span> <span class="n">CustomCost</span><span class="p">,</span> <span class="n">CustomCostResponse</span>
<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="k">def</span> <span class="nf">handle_random_cost</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">random</span><span class="p">()</span>
    <span class="n">rospy</span><span class="p">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s">"Returning cost: %f"</span><span class="o">%+-</span><span class="mi">3</span><span class="n">cost</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cost</span>

<span class="k">def</span> <span class="nf">random_cost_server</span><span class="p">():</span>
    <span class="n">rospy</span><span class="p">.</span><span class="n">init_node</span><span class="p">(</span><span class="s">'random_cost_server'</span><span class="p">)</span>
    <span class="n">rospy</span><span class="p">.</span><span class="n">Service</span><span class="p">(</span><span class="s">'custom_cost'</span><span class="p">,</span> <span class="n">CustomCost</span><span class="p">,</span> <span class="n">handle_random_cost</span><span class="p">)</span>
    <span class="n">rospy</span><span class="p">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s">"Ready to compute random cost."</span><span class="p">)</span>
    <span class="n">rospy</span><span class="p">.</span><span class="n">spin</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">random_cost_server</span><span class="p">()</span>

</pre></table></code></div></div><p>The main thing to note is that there is nothing special about this ROS service except that it imports the <code class="language-plaintext highlighter-rouge">CustomCost</code> srv file from the OMPL package and the service name is <code class="language-plaintext highlighter-rouge">custom_cost</code>. These two aspects are important since our fork of OMPL defines the srv file and is expecting to find a service waiting for calls with the name <code class="language-plaintext highlighter-rouge">custom_cost</code>. The srv file is located at <code class="language-plaintext highlighter-rouge">~/ws_moveit/src/ompl/srv/CustomCost.srv</code> and is printed below:</p><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">float64</span><span class="p">[]</span> <span class="n">state</span>
<span class="o">---</span>
<span class="n">float64</span> <span class="n">cost</span>
</pre></table></code></div></div><p>Just to make sure everything is set up properly, let’s build one more time and re-source the workspace.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">cd</span> ~/ws_moveit
<span class="nb">sudo </span>catkin build
<span class="nb">source</span> ./devel/setup.bash
</pre></table></code></div></div><h3 id="testing-the-setup"><span class="mr-2">Testing the Setup</span><a href="#testing-the-setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Alright, now let’s do a sanity check and make sure that everything works as intended. To do this, we’re going to follow a MoveIt! motion planning tutorial in <code class="language-plaintext highlighter-rouge">rviz</code> with the Panda robot arm. This will make sure that all the different components to our system are properly configured. This tutorial can be found on the MoveIt! docs website <a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="http://docs.ros.org/kinetic/api/moveit_tutorials/html/doc/quickstart_in_rviz/quickstart_in_rviz_tutorial.html" target="_blank">here</a>, but I’ll include the steps below for the sake of completeness and since we need to make a slight change to get it working with our system.</p><p>Before we run the demo, we need to first edit the <code class="language-plaintext highlighter-rouge">ompl_planning.yaml</code> file that configures how the demo interacts with OMPL. First we need to move into the <code class="language-plaintext highlighter-rouge">panda_moveit_config</code> package and then we need to edit the configuration file. You can open it in whatever text editor you prefer, but on my system I need to use <code class="language-plaintext highlighter-rouge">sudo</code> since it’s in the <code class="language-plaintext highlighter-rouge">/opt</code> directory.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>roscd panda_moveit_config
<span class="nb">sudo </span>gedit config/ompl_planning.yaml
</pre></table></code></div></div><p>And then add <code class="language-plaintext highlighter-rouge">optimization_objective: CustomObjective</code> inside the heading “RRTstarkConfigDefault” right under the “type” key. The final section should look like this:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>  <span class="na">RRTstarkConfigDefault</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">geometric::RRTstar</span>
    <span class="na">optimization_objective</span><span class="pi">:</span> <span class="s">CustomObjective</span>
    <span class="na">range</span><span class="pi">:</span> <span class="m">0.0</span>  <span class="c1"># Max motion added to tree. ==&gt; maxDistance_ default: 0.0, if 0.0, set on setup()</span>
    <span class="na">goal_bias</span><span class="pi">:</span> <span class="m">0.05</span>  <span class="c1"># When close to goal select goal, with this probability? default: 0.05</span>
    <span class="na">delay_collision_checking</span><span class="pi">:</span> <span class="m">1</span>  <span class="c1"># Stop collision checking as soon as C-free parent found. default</span>
</pre></table></code></div></div><p>By making this change you’re requesting OMPL to use our custom objective. This can be changed through the <code class="language-plaintext highlighter-rouge">rviz</code> interface later on, but we’re setting the default here in the configuration and making sure the <code class="language-plaintext highlighter-rouge">optimization_objective</code> key exists. Note that we’ve only added this for the RRT* optimizing planner. If you wish to test this with other planners you’ll have to change those as well.</p><p>Okay, so now the demo is configured properly we can walk through it and make sure everything works. Let’s go ahead and start the demo in <code class="language-plaintext highlighter-rouge">rviz</code>. I’ll let you follow along with the tutorial <a rel="noreferrer noopener" aria-label="here (opens in a new tab)" href="http://docs.ros.org/kinetic/api/moveit_tutorials/html/doc/quickstart_in_rviz/quickstart_in_rviz_tutorial.html" target="_blank">here</a>. Go ahead and walk through all the steps if you’re unfamiliar with MoveIt! and <code class="language-plaintext highlighter-rouge">rviz</code>. Once you’re comfortable with it, come back here and let’s test our custom objective setup.</p><p>All good? Alright, to run our custom objective we need to select the RRT* (<code class="language-plaintext highlighter-rouge">RRTstarkConfigDefault</code>) planner from the drop down in the MotionPlanning pane. It should like this:</p><figure> <img data-src="/assets/posts/rviz-motion-planning-context.png" alt="MotionPlanning pane in rviz after selecting RRT*" data-proofer-ignore></figure><p>Now click on the <code class="language-plaintext highlighter-rouge">Planning</code> tab and then select <code class="language-plaintext highlighter-rouge">Plan and Execute</code> (note that your robot must have different start and goal positions for anything to happen). See below:</p><figure> <img data-src="/assets/posts/rviz-motion-planning-planning.png" alt="Executing the planning through OMPL" data-proofer-ignore></figure><p>Now if you go back to the terminal in which you ran the <code class="language-plaintext highlighter-rouge">roslaunch</code> command above, you should notice a bunch of warning messages saying something like:</p><pre><code class="language-log">[ WARN] [1572387284.914557300]: Failed to call service custom_cost. Using clearance instead.
</code></pre><p>This is because we haven’t started a ROS server that is ready to send out costs to OMPL. Since OMPL can’t find the server, it simply defaults to checking the clearance as the cost function for each state.</p><p>In order to start our ROS cost server, we can simply launch it using the <code class="language-plaintext highlighter-rouge">rosrun</code> command from another terminal (assuming the ROS master node is still running from our <code class="language-plaintext highlighter-rouge">roslaunch</code> command):</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>rosrun ompl_cost_server_demos random_cost.py
</pre></table></code></div></div><p>The above command runs the server we showed the code for above. This server simply publishes random values for the cost to OMPL.</p><p>Now that we have that running, go back to <code class="language-plaintext highlighter-rouge">rviz</code> and move the start and goal positions of the arm. Once that is done, click <code class="language-plaintext highlighter-rouge">Plan and Execute</code> again to make OMPL attempt to find a solution.</p><p>If all worked correctly you should see something like the following output from the server node:</p><pre><code class="language-log">[INFO] [1572387558.281799]: Returning cost: 0.743727
</code></pre><p>This means that OMPL is asking your server for the cost of different states and everything is working!</p><h3 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>This was a pretty lengthy walk through, but I hope you haven’t lost sight of the potential of this kind of a system. It allows you to do two very powerful things:</p><ol><li>It allows you to easily add and modify optimization objectives (cost functions) for OMPL without having to touch the OMPL source code. This means that you can modify cost functions without having to recompile. Note also that you can even have the whole system running, take down your cost server and launch a new one without ever having to stop your main OMPL/MoveIt!/rviz client. Also you can see that your cost function doesn’t have to be written in C++. These demo ones are written in Python even though OMPL is written in C++!<li>This system also allows for your cost functions to leverage the full power of the ROS stack. While OMPL has a limited understanding of the environment it operates in, your cost function can read from any ROS topic you’d like. This means your cost function can utilize sensor data or even user input which allows it to be a dynamic part of your system.</ol><p>Please let me know if any of this doesn’t work for you or if you have comments or improvements to offer. This is a project I’m actively working on and hope to implement some cool cost functions using this methodology. Hope this helps you as well!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/development/'>development</a>, <a href='/categories/tutorial/'>tutorial</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ros/" class="post-tag no-text-decoration" >ros</a> <a href="/tags/robotics/" class="post-tag no-text-decoration" >robotics</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Custom Cost Function for OMPL &amp; MoveIt! through ROS - Jack Kawell&amp;url=https://jack.kawell.us/posts/ompl-cost-functions/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Custom Cost Function for OMPL &amp; MoveIt! through ROS - Jack Kawell&amp;u=https://jack.kawell.us/posts/ompl-cost-functions/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://jack.kawell.us/posts/ompl-cost-functions/&amp;text=Custom Cost Function for OMPL &amp; MoveIt! through ROS - Jack Kawell" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://jack.kawell.us/posts/ompl-cost-functions/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/sff-development-gaming-pc/">Building a Custom SFF Development and Gaming PC</a><li><a href="/posts/ompl-moveit-custom-motion-planning/">Installing OMPL/MoveIt! for custom motion planning</a><li><a href="/posts/ros-windows-wsl/">Setting up ROS in Windows through WSL</a><li><a href="/posts/ros-windows-docker/">Setting up ROS in Windows through Docker</a><li><a href="/posts/ompl-cost-functions/">Custom Cost Function for OMPL & MoveIt! through ROS</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/robotics/">robotics</a> <a class="post-tag" href="/tags/ros/">ros</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/wsl/">wsl</a> <a class="post-tag" href="/tags/cmd/">cmd</a> <a class="post-tag" href="/tags/computer/">computer</a> <a class="post-tag" href="/tags/diy/">diy</a> <a class="post-tag" href="/tags/hobby/">hobby</a> <a class="post-tag" href="/tags/motion-planning/">motion planning</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/ompl-moveit-custom-motion-planning/"><div class="card-body"> <em class="timeago small" data-ts="1561395600" > 2019-06-24 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Installing OMPL/MoveIt! for custom motion planning</h3><div class="text-muted small"><p> Introduction I am in the process of creating a customized version of an OMPL planner that uses a personalized costmap to help robots learn to move around people in a more comfortable way. In order...</p></div></div></a></div><div class="card"> <a href="/posts/ros-windows-wsl/"><div class="card-body"> <em class="timeago small" data-ts="1561395600" > 2019-06-24 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Setting up ROS in Windows through WSL</h3><div class="text-muted small"><p> UPDATE This post is now deprecated with the public launch of WSL2. I have a new post documenting how to do this same set up with WSL2. Check it out over here. NOTE: If you are not running Windows...</p></div></div></a></div><div class="card"> <a href="/posts/ros-windows-docker/"><div class="card-body"> <em class="timeago small" data-ts="1568221200" > 2019-09-11 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Setting up ROS in Windows through Docker</h3><div class="text-muted small"><p> In another post, I wrote about setting up a ROS development environment within Windows using WSL. Since then, I’ve had a few people ask me about setting up the same system except using Docker. This...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/realsense-sdk-odroid/" class="btn btn-outline-primary" prompt="Older"><p>Installing RealSense SDK on an ODROID-XU4</p></a> <a href="/posts/powerline-wsl-vs-code/" class="btn btn-outline-primary" prompt="Newer"><p>Setting up Powerline in WSL and VS Code</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "jgkawell/jgkawell.github.io", "data-repo-id": "R_kgDOHaXBOw", "data-category": "General", "data-category-id": "DIC_kwDOHaXBO84CPWL5", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "bottom", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/jgkawell">Jack Kawell</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/robotics/">robotics</a> <a class="post-tag" href="/tags/ros/">ros</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/wsl/">wsl</a> <a class="post-tag" href="/tags/cmd/">cmd</a> <a class="post-tag" href="/tags/computer/">computer</a> <a class="post-tag" href="/tags/diy/">diy</a> <a class="post-tag" href="/tags/hobby/">hobby</a> <a class="post-tag" href="/tags/motion-planning/">motion planning</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
